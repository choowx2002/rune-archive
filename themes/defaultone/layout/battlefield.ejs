<%- partial('components/header/progress-bar') %>
    <% if (theme.global.preloader===true || theme.global.preloader.enable===true) { %>
        <%- partial('components/header/preloader') %>
            <% } %>

                <head>
                    <meta charset="UTF-8">
                    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
                </head>

                <main class="page-container" id="swup">
                    <div class="main-content-container flex flex-col justify-between min-h-dvh">
                        <div class="main-content-header">
                            <%- partial('components/header/navbar') %>
                        </div>

                        <div class="main-content-body transition-fade-up">
                            <div class="main-content">
                                <h5>当前链顺序：</h5>
                                <div id="result"
                                    class="p-4 text-center"
                                    style="border: 1px solid var(--default-text-color);margin: 5px 0; border-radius: 5px; font-weight: bolder;box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);"
                                    >
                                    暂无
                                </div>

                                <div class="flex gap-6">
                                    <!-- 左边：链 -->
                                    <div class="flex-1">
                                        <h2 class="text-lg font-semibold mb-2">结算链 (Chain)</h2>
                                        <div id="chain"
                                            style="box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);"
                                            class="min-h-[300px] border-2 border-dashed border-gray-400 dark:border-gray-600 p-3 rounded-xl flex flex-col">
                                            <p class="text-gray-400 dark:text-gray-500 text-center my-auto">拖拽卡牌到这里形成结算链
                                            </p>
                                        </div>
                                    </div>

                                    <!-- 中间：预留 -->
                                    <div class="flex-1 hidden lg:block">
                                        <h2 class="text-lg font-semibold mb-2">战场区域 (预留)</h2>
                                        <div
                                            class="h-[300px] flex items-center justify-center border border-gray-300 dark:border-gray-700 rounded-xl bg-gray-50 text-gray-400">
                                            未来可以扩展这里
                                        </div>
                                    </div>

                                    <!-- 右边：卡池 -->
                                    <aside style="width: 20rem;">
                                        <h2 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">
                                            卡牌池
                                        </h2>

                                        <input type="text" id="searchBox" placeholder="搜索卡牌名称..."
                                            style="width: 100%; margin-bottom: 0.75rem; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #d1d5db; box-sizing: border-box; background-color: var(--background-color);">

                                        <div id="pool"
                                            style="height: 60vh; overflow-y: auto; border: 2px dashed #9ca3af; padding: 0.75rem; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                            <p style="text-align: center;">加载中...</p>
                                        </div>
                                    </aside>

                                </div>
                            </div>
                        </div>

                        <div class="main-content-footer">
                            <%- partial('components/footer/footer') %>
                        </div>
                    </div>
                    <div class="right-side-tools-container">
                        <%- partial('utils/side-tools') %>
                    </div>
                    <script>
                        const pool = document.getElementById("pool");
                        const chain = document.getElementById("chain");
                        const resultBox = document.getElementById("result");
                        const searchBox = document.getElementById("searchBox");

                        let allCards = [];

                        // 加载 JSON
                        async function loadCards() {
                            try {
                                const res = await fetch("https://cdn.jsdelivr.net/gh/choowx2002/project_k_image/cardDB.json");
                                const data = await res.json();
                                allCards = data.filter(c => c.extend_rarity_name === "平卡");
                                renderCards(allCards);
                            } catch (e) {
                                pool.innerHTML = `<p class="text-red-500">加载失败: ${e}</p>`;
                            }
                        }

                        // 渲染卡牌
                        function renderCards(cards) {
                            pool.innerHTML = "";
                            if (cards.length === 0) {
                                pool.innerHTML = `<p class="text-gray-400 dark:text-gray-500 text-center">没有匹配的卡牌</p>`;
                                return;
                            }
                            cards.forEach(card => {
                                const div = document.createElement("div");
                                div.className = "mb-2 rounded-lg bg-blue-100 dark:bg-blue-700 border border-blue-300 dark:border-blue-500 cursor-grab";
                                div.style.padding = "8px";
                                div.style.textAlign = "center";
                                div.style.userSelect = "none";
                                // 名称 + 副标题
                                let title = card.card_name;
                                if (card.sub_title && card.sub_title.trim() !== "") {
                                    title += " · " + card.sub_title;
                                }
                                div.innerText = title;

                                div.dataset.id = card.card_no;
                                pool.appendChild(div);
                            });
                        }

                        // 搜索过滤
                        searchBox.addEventListener("input", e => {
                            const keyword = e.target.value.toLowerCase();
                            const filtered = allCards.filter(c => {
                                const name = c.card_name ? c.card_name.toLowerCase() : "";
                                const sub = c.sub_title ? c.sub_title.toLowerCase() : "";
                                return name.includes(keyword) || sub.includes(keyword);
                            });
                            renderCards(filtered);
                        });

                        // 卡池
                        new Sortable(pool, {
                            group: {
                                name: "shared",
                                pull: "clone",   // 拖拽时复制
                                put: false       // 禁止把东西放回池子
                            },
                            animation: 150,
                            sort: false        // Pool 内部不排序，固定列表
                        });

                        // 链
                        new Sortable(chain, {
                            group: "shared",
                            animation: 150,
                            onSort: updateChain
                        });

                        // 更新链顺序
                        function updateChain() {
                            const cards = [...chain.querySelectorAll("div[data-id]")].map(r => r.innerText);
                            if (cards.length === 0) {
                                resultBox.innerText = "暂无";
                            } else {
                                resultBox.innerText = cards.join(" ← ");
                            }
                        }

                        chain.addEventListener("contextmenu", e => {
                            if (e.target && e.target.dataset.id) {
                                e.preventDefault(); // 阻止浏览器默认菜单
                                e.target.remove();  // 删除该卡
                                updateChain();      // 更新链顺序
                            }
                        });

                        // 初始化
                        loadCards();
                    </script>
import{main}from"../main.js";import{initTOC}from"../layouts/toc.js";function initHBE(){let a=window.crypto||window.msCrypto,i=window.localStorage,l="hexo-blog-encrypt:#"+window.location.pathname,c=n("too young too simple"),s=n("sometimes naive!"),o="<hbe-prefix></hbe-prefix>",e=document.getElementById("hexo-blog-encrypt"),d=e.dataset.wpm,m=e.dataset.whm;var t=e.getElementsByTagName("script").hbeData;let y=t.innerText,h=t.dataset.hmacdigest;function u(e){return new Uint8Array(e.match(/[\da-f]{2}/gi).map(e=>parseInt(e,16)))}function n(e){for(var t=e.length,n=0,r=new Array,o=0;o<t;){var a=e.codePointAt(o);a<128?(r[n++]=a,o++):127<a&&a<2048?(r[n++]=a>>6|192,r[n++]=63&a|128,o++):2047<a&&a<65536?(r[n++]=a>>12|224,r[n++]=a>>6&63|128,r[n++]=63&a|128,o++):(r[n++]=a>>18|240,r[n++]=a>>12&63|128,r[n++]=a>>6&63|128,r[n++]=63&a|128,o+=2)}return new Uint8Array(r)}async function p(e){var t=document.createElement("div");return t.innerHTML=e,t.querySelectorAll("script").forEach(async e=>{e.replaceWith(await(async t=>{let n=document.createElement("script");return["type","text","src","crossorigin","defer","referrerpolicy"].forEach(e=>{t[e]&&(n[e]=t[e])}),n})(e))}),t}async function g(e,t,r){var n=u(y);return await a.subtle.decrypt({name:"AES-CBC",iv:t},e,n.buffer).then(async e=>{var t,n,e=(new TextDecoder).decode(e);if(e.startsWith(o))return(t=document.createElement("button")).textContent="Encrypt again",t.type="button",t.classList.add("hbe-button"),t.addEventListener("click",()=>{window.localStorage.removeItem(l),window.location.reload()}),document.getElementById("hexo-blog-encrypt").style.display="inline",document.getElementById("hexo-blog-encrypt").innerHTML="",document.getElementById("hexo-blog-encrypt").appendChild(await p(e)),document.getElementById("hexo-blog-encrypt").appendChild(t),document.querySelectorAll("img").forEach(e=>{e.getAttribute("data-src")&&!e.src&&(e.src=e.getAttribute("data-src"))}),main.refresh(),initTOC(),t=new Event("hexo-blog-decrypt"),window.dispatchEvent(t),t=r,e=e,e=(new TextEncoder).encode(e),n=u(h),t=await a.subtle.verify({name:"HMAC",hash:"SHA-256"},t,n,e),console.log("Verification result: "+t),t||(alert(m),console.log(m+", got ",n," but proved wrong.")),t;throw"Decode successfully but not start with KnownPrefix."}).catch(e=>(alert(d),console.log(e),!1))}t=JSON.parse(i.getItem(l));if(t){console.log(`Password got from localStorage(${l}): `,t);let n=u(t.iv).buffer;var r=t.dk;let e=t.hmk;a.subtle.importKey("jwk",r,{name:"AES-CBC",length:256},!0,["decrypt"]).then(t=>{a.subtle.importKey("jwk",e,{name:"HMAC",hash:"SHA-256",length:256},!0,["verify"]).then(e=>{g(t,n,e).then(e=>{e||i.removeItem(l)})})})}e.addEventListener("keydown",async e=>{if(e.isComposing||"Enter"===e.key){e=document.getElementById("hbePass").value,o=(e=e,o=new TextEncoder,await a.subtle.importKey("raw",o.encode(e),{name:"PBKDF2"},!1,["deriveKey","deriveBits"]));e=o;let n=await a.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:c.buffer,iterations:1024},e,{name:"HMAC",hash:"SHA-256",length:256},!0,["verify"]),t=(e=o,await a.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:c.buffer,iterations:1024},e,{name:"AES-CBC",length:256},!0,["decrypt"])),r=(e=o,await a.subtle.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:s.buffer,iterations:512},e,128));g(t,r,n).then(e=>{console.log("Decrypt result: "+e),e&&a.subtle.exportKey("jwk",t).then(t=>{a.subtle.exportKey("jwk",n).then(e=>{e={dk:t,iv:(e=>{if("object"!=typeof e||null===e||"number"!=typeof e.byteLength)throw new TypeError("Expected input to be an ArrayBuffer");for(var t,n=new Uint8Array(e),r="",o=0;o<n.length;o++)r+=1===(t=n[o].toString(16)).length?"0"+t:t;return r})(r),hmk:e};i.setItem(l,JSON.stringify(e))})})})}var o})}export{initHBE};